name: Submit Sitemap to Google

on:
  # æ¯å‘¨ä¸€æ¬¡è‡ªåŠ¨è¿è¡Œ(æ¨èæ—¶é—´ä¸ºå‘¨ä¸€å‡Œæ™¨,é¿å¼€é«˜å³°æœŸ)
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2:00 UTC (å‘¨ä¸€ä¸Šåˆ 10:00 CST)
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # éƒ¨ç½²åä¹Ÿè§¦å‘ä¸€æ¬¡
  workflow_run:
    workflows: ["Deploy to GitHub Pages & Cloudflare Workers"]
    types:
      - completed
    branches: [main]

jobs:
  submit-sitemap:
    runs-on: ubuntu-latest
    # åªåœ¨éƒ¨ç½²æˆåŠŸåè¿è¡Œ
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build site to generate fresh sitemap
        run: npm run build
        env:
          # ç¡®ä¿ç”Ÿæˆæ­£ç¡®çš„ sitemap URL
          SITE_URL: https://genedai.space

      - name: Verify sitemap exists
        run: |
          if [ ! -f "docs/.vitepress/dist/sitemap.xml" ]; then
            echo "âŒ Sitemap not found!"
            exit 1
          fi
          echo "âœ… Sitemap generated successfully"
          echo "ğŸ“Š Sitemap size: $(wc -c < docs/.vitepress/dist/sitemap.xml) bytes"
          echo "ğŸ“ URL count: $(grep -o '<loc>' docs/.vitepress/dist/sitemap.xml | wc -l)"

      - name: Submit sitemap to Google
        uses: atymic/sitemap-submitter-action@v2.0.0
        with:
          sitemap_url: https://genedai.space/sitemap.xml
          google_service_account_email: ${{ secrets.GOGLE_SERVICE_ACCOUNT_EMAIL }}
          google_service_account_key: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          # ç­‰å¾…æ—¶é—´(ç§’),é¿å…è¯·æ±‚è¿‡å¿«
          delay: 1

      - name: Create submission report
        if: always()
        run: |
          echo "## Sitemap æäº¤æŠ¥å‘Š" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sitemap URL**: https://genedai.space/sitemap.xml" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "æ¯å‘¨ä¸€å‡Œæ™¨ 2:00 UTC (å‘¨ä¸€ä¸Šåˆ 10:00 CST)" >> $GITHUB_STEP_SUMMARY

      - name: Wait for Google processing
        run: |
          echo "â³ Sitemap å·²æäº¤ç»™ Google"
          echo "ğŸ“Œ Google é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶æ¥å¤„ç† sitemap"
          echo "ğŸ“Š è¯·åœ¨ Google Search Console æŸ¥çœ‹æ”¶å½•çŠ¶æ€:"
          echo "   https://search.google.com/search-console"

      - name: Monitor submission status (optional)
        if: success()
        run: |
          echo "âœ… Sitemap æäº¤æˆåŠŸ!"
          echo ""
          echo "ğŸ’¡ å»ºè®®:"
          echo "  1. åœ¨ Google Search Console æŸ¥çœ‹ç´¢å¼•çŠ¶æ€"
          echo "  2. æ£€æŸ¥ coverage æŠ¥å‘Šäº†è§£é¡µé¢æ”¶å½•æƒ…å†µ"
          echo "  3. æŸ¥çœ‹ URL inspection å·¥å…·ç¡®è®¤å…·ä½“é¡µé¢çŠ¶æ€"
